### 1. 일반 회원 가입

*   **1. 입력**
    *   사용자가 회원가입 페이지(`sign-up`)로 진입한다.
    *   사용자가 '일반 회원' 탭을 선택한다.
    *   사용자가 이메일, 비밀번호, 닉네임 정보를 입력한다.
    *   사용자가 서비스 이용약관 및 개인정보 처리방침에 동의한다.
    *   사용자가 가입 완료 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 입력된 정보(이메일 형식, 비밀번호 길이 등)의 유효성을 검증한다.
    2.  시스템은 이미 동일한 이메일로 가입된 계정이 있는지 데이터베이스에서 확인한다.
    3.  유효성 검증 및 중복 확인을 통과하면, 시스템은 'user' 역할을 가진 새로운 사용자 계정을 생성하고 데이터베이스에 저장한다.
    4.  시스템은 사용자를 위한 인증 세션을 생성한다.
*   **3. 출력**
    *   회원가입이 성공적으로 완료되었음을 알리는 피드백을 표시한다.
    *   사용자를 AI 빠른상담 페이지(`/ai-qna`)로 리디렉션시킨다.
*   **엣지케이스 대응**
    *   입력 정보의 형식이 유효하지 않을 경우: 오류가 발생한 입력 필드 하단에 해당 사유를 명시하고 가입 절차를 중단한다.
    *   이미 가입된 이메일일 경우: 이메일 중복을 알리는 메시지를 표시하고 가입 절차를 중단한다.
    *   처리 과정에서 서버 또는 데이터베이스 오류 발생 시: "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요."와 같은 메시지를 표시한다.

### 2. 변호사 회원 가입

*   **1. 입력**
    *   사용자가 회원가입 페이지(`sign-up?type=lawyer`)로 진입한다.
    *   사용자가 '변호사 회원' 탭을 선택한다.
    *   사용자가 이메일, 비밀번호, 닉네임, 성명(실명), 변호사 등록번호를 입력한다.
    *   사용자가 서비스 이용약관 및 개인정보 처리방침에 동의한다.
    *   사용자가 가입 완료 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 일반 회원 가입과 동일한 유효성 검증 및 이메일 중복 확인을 수행한다.
    2.  검증을 통과하면, 시스템은 'lawyer' 역할을 부여하고, 인증 상태를 '미인증(pending)'으로 설정하여 새로운 사용자 계정을 생성한다.
    3.  시스템은 사용자를 위한 인증 세션을 생성한다.
*   **3. 출력**
    *   회원가입 성공 및 자격 증명 서류 제출이 필요함을 안내하는 피드백을 표시한다.
    *   사용자를 마이페이지(`/my-page`)로 리디렉션시킨다.
*   **엣지케이스 대응**
    *   일반 회원 가입의 모든 엣지케이스를 포함한다.

### 3. 변호사 자격 인증

*   **1. 입력**
    *   변호사 회원이 마이페이지의 '변호사 인증 관리' 메뉴로 진입한다.
    *   사용자가 자격 증명 파일(.jpg, .pdf)을 선택하고 업로드 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 업로드된 파일의 확장자 및 크기가 허용 기준을 만족하는지 검증한다.
    2.  시스템은 파일을 안전한 스토리지(Private Bucket)에 업로드한다.
    3.  시스템은 해당 변호사 회원의 인증 상태를 '심사 중(in_review)'으로 변경하고, 파일 경로와 함께 데이터베이스에 기록한다.
*   **3. 출력**
    *   서류 제출이 완료되었으며 관리자 승인을 대기 중이라는 피드백을 표시한다.
    *   '변호사 인증 관리' 메뉴에 현재 심사 상태가 표시된다.
*   **엣지케이스 대응**
    *   허용되지 않은 파일 형식 또는 크기 초과 시: 오류 메시지를 표시하고 업로드를 차단한다.
    *   파일 업로드 중 네트워크 또는 서버 오류 발생 시: 업로드 실패 메시지를 표시하고 재시도를 유도한다.
    *   이미 심사 중이거나 승인된 회원이 재업로드를 시도할 경우: 현재 상태를 안내하고 업로드를 제한한다.

### 4. 관리자의 변호사 승인 처리

*   **1. 입력**
    *   관리자가 관리자 페이지(`/admin/lawyer-approval`)에 로그인하여 승인 대기 목록을 확인한다.
    *   관리자가 특정 변호사 회원의 제출 서류를 확인한다.
    *   관리자가 '승인' 또는 '반려' 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 관리자의 요청(승인/반려)에 따라 해당 변호사 회원의 인증 상태를 '승인(approved)' 또는 '반려(rejected)'로 데이터베이스에서 변경한다.
    2.  승인 또는 반려 처리 시, 해당 변호사 회원에게 상태 변경을 알리는 시스템 알림을 생성한다.
*   **3. 출력**
    *   처리된 변호사 회원이 승인 대기 목록에서 사라진다.
    *   관리자에게 처리 완료 피드백을 표시한다.
*   **엣지케이스 대응**
    *   존재하지 않는 회원에 대한 처리 요청 시: 요청을 무시하고 목록을 갱신한다.
    *   처리 중 데이터베이스 연결 오류 발생 시: 처리 실패 메시지를 표시하고 관리자의 재시도를 유도한다.

### 5. AI 질문 및 공개

*   **1. 입력**
    *   사용자가 AI 빠른상담 페이지(`/ai-qna`)에서 질문을 입력하고 전송한다.
    *   사용자가 '이 질문을 변호사에게 공개' 체크박스의 선택 상태를 유지하거나 변경한다.
    *   사용자가 '대화 종료' 버튼을 클릭한다.
*   **2. 처리**
    1.  (질문 전송 시) 시스템은 현재까지의 대화 내용을 포함하여 백엔드로 전송한다.
    2.  백엔드는 이 대화 맥락을 Gemini API로 전달하고, 응답을 받아 스트리밍 형태로 프론트엔드에 다시 전송한다.
    3.  ('대화 종료' 시) 시스템은 체크박스 상태를 확인한다.
    4.  체크박스가 선택된 경우, 전체 대화 내용을 하나의 '질문' 데이터로 생성하고 '공개(public)' 상태로 데이터베이스에 저장한다.
    5.  체크박스가 해제된 경우, '비공개(private)' 상태로 저장한다.
    6.  질문 생성 시각을 기록한다.
*   **3. 출력**
    *   AI의 답변이 채팅 UI에 순차적으로 표시된다.
    *   '대화 종료' 시, 대화가 저장되었음을 알리는 피드백과 함께 만족도 평가 UI를 표시한다.
*   **엣지케이스 대응**
    *   AI API 호출 실패 또는 응답 지연 시: "AI 답변 생성에 실패했습니다. 잠시 후 다시 시도해주세요."와 같은 메시지를 표시한다.
    *   '대화 종료' 시 데이터베이스 저장 실패 시: "대화 저장에 실패했습니다." 메시지를 표시하고 재시도 옵션을 제공할 수 있다.

### 6. 변호사 포인트 충전

*   **1. 입력**
    *   변호사 회원이 마이페이지의 '포인트 관리' 메뉴에서 충전할 금액을 선택한다.
    *   사용자가 결제 버튼을 클릭하여 외부 결제(Toss Payments) 페이지로 이동한다.
    *   사용자가 외부 결제 페이지에서 결제를 완료한다.
*   **2. 처리**
    1.  시스템은 선택된 금액으로 결제 요청을 생성하고 외부 결제 API를 호출한다.
    2.  외부 결제 시스템으로부터 결제 성공 콜백(Callback) 또는 웹훅(Webhook) 알림을 수신한다.
    3.  시스템은 수신된 결제 정보의 유효성과 일치 여부를 검증한다.
    4.  검증 완료 시, 해당 변호사 회원의 포인트 잔액을 충전 금액만큼 증가시킨다.
    5.  포인트 충전 내역을 트랜잭션 기록으로 데이터베이스에 저장한다.
*   **3. 출력**
    *   결제 완료 후 서비스 페이지로 복귀하며 충전 성공 피드백을 표시한다.
    *   마이페이지의 포인트 잔액이 실시간으로 갱신된다.
*   **엣지케이스 대응**
    *   사용자가 결제를 중간에 취소할 경우: 결제가 취소되었음을 알리는 페이지로 이동시킨다.
    *   결제는 성공했으나 콜백/웹훅 수신 실패 또는 데이터베이스 업데이트 실패 시: 결제 상태 불일치를 감지하는 로직을 통해 관리자에게 알리고, 수동 처리를 위한 로그를 기록한다. 사용자에게는 문의를 유도하는 안내를 표시한다.

### 7. 변호사 답변 작성

*   **1. 입력**
    *   '승인' 상태의 변호사 회원이 변호사 전문가 답변 페이지(`/lawyer-board`)에서 질문을 선택한다.
    *   질문 상세 페이지(`/qna/{questionId}`)에서 답변 입력창에 내용을 작성하고 제출 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 답변 제출 요청을 한 회원이 '승인' 상태의 변호사인지 확인한다.
    2.  시스템은 해당 회원의 포인트 잔액이 답변에 필요한 포인트(1,000P) 이상인지 확인한다.
    3.  시스템은 데이터베이스 트랜잭션을 시작한다.
    4.  변호사 회원의 포인트를 차감한다.
    5.  포인트 사용 내역을 트랜잭션 기록으로 저장한다.
    6.  작성된 내용을 '답변' 데이터로 생성하여 해당 질문에 연결하여 저장한다.
    7.  시스템은 데이터베이스 트랜잭션을 완료(commit)한다.
    8.  질문 작성자에게 새로운 답변이 등록되었음을 알리는 시스템 알림을 생성한다.
*   **3. 출력**
    *   작성한 답변이 질문 상세 페이지의 답변 목록에 추가된다.
    *   답변 작성 성공 및 포인트 차감 안내 피드백을 표시한다.
*   **엣지케이스 대응**
    *   포인트가 부족할 경우: "포인트가 부족합니다. 충전 후 이용해주세요." 메시지를 표시하고 충전 페이지로 이동하는 링크를 제공한다.
    *   답변 제출 과정에서 트랜잭션 실패 시: 모든 변경사항(포인트 차감, 답변 생성)을 롤백(rollback)하고, 사용자에게 서버 오류 메시지를 표시한다.
    *   질문이 답변 제출 직전에 삭제된 경우: "더 이상 답변할 수 없는 질문입니다." 메시지를 표시하고 게시판 목록으로 돌려보낸다.

### 8. 질문자 질문 삭제 (1시간 이내)

*   **1. 입력**
    *   질문 작성자가 질문 등록 후 1시간 이내에 질문 상세 페이지 또는 마이페이지에서 '삭제하기' 버튼을 클릭한다.
    *   삭제 확인 모달에서 '확인'을 클릭한다.
*   **2. 처리**
    1.  시스템은 현재 사용자가 해당 질문의 작성자인지 확인한다.
    2.  시스템은 질문 생성 시각과 현재 시각을 비교하여 1시간이 경과하지 않았는지 확인한다.
    3.  시스템은 데이터베이스 트랜잭션을 시작한다.
    4.  해당 질문에 달린 모든 답변을 조회한다.
    5.  각 답변을 작성한 변호사 회원에게 사용했던 포인트(1,000P)를 환불한다.
    6.  포인트 환불 내역을 트랜잭션 기록으로 저장한다.
    7.  모든 관련 답변 데이터를 삭제한다.
    8.  원본 질문 데이터를 삭제한다.
    9.  시스템은 데이터베이스 트랜잭션을 완료(commit)한다.
*   **3. 출력**
    *   질문이 성공적으로 삭제되었음을 알리는 피드백을 표시한다.
    *   사용자를 변호사 전문가 답변 페이지(`/lawyer-board`)로 리디렉션시킨다.
*   **엣지케이스 대응**
    *   질문 등록 후 1시간이 경과했을 경우: '삭제하기' 버튼이 비활성화되거나, 클릭 시 "등록 후 1시간이 지난 질문은 삭제할 수 없습니다." 메시지를 표시한다.
    *   삭제 권한이 없는 사용자가 접근할 경우: '삭제하기' 버튼을 표시하지 않는다.
    *   처리 중 트랜잭션 실패 시: 모든 변경사항을 롤백하고 서버 오류 메시지를 표시한다.

### 9. 질문자 답변 채택

*   **1. 입력**
    *   질문 작성자가 질문 상세 페이지에서 여러 변호사 답변 중 하나에 있는 '답변 채택하기' 버튼을 클릭한다.
*   **2. 처리**
    1.  시스템은 현재 사용자가 해당 질문의 작성자인지 확인한다.
    2.  시스템은 해당 질문에 이미 채택된 답변이 있는지 확인한다.
    3.  선택된 답변의 상태를 '채택(adopted)'으로 데이터베이스에서 변경한다.
    4.  질문의 상태를 '채택 완료'로 변경한다.
    5.  답변을 작성한 변호사 회원에게 답변이 채택되었음을 알리는 시스템 알림을 생성한다.
*   **3. 출력**
    *   채택된 답변이 시각적으로 구분되어 답변 목록 최상단으로 이동한다.
    *   해당 질문의 모든 답변에서 '답변 채택하기' 버튼이 비활성화된다.
    *   '채택 완료' 배지가 질문 제목 근처에 표시된다.
*   **엣지케이스 대응**
    *   이미 채택된 답변이 있는 상태에서 다른 답변을 채택 시도할 경우: "이미 채택된 답변이 있습니다." 메시지를 표시하고 요청을 거부한다.
    *   자신이 작성한 질문이 아닐 경우: '답변 채택하기' 버튼을 표시하지 않는다.